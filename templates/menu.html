{% extends 'base.html' %}
{% load static %}
{% block title %}Menu - SmartDine{% endblock %}

{% block extra_css %}
<style>
    .menu-wrapper {
        padding: 4rem 0 8rem;
        background-color: var(--bg-main);
    }

    .category-filter {
        position: sticky;
        top: 85px;
        /* Account for navbar */
        z-index: 10;
        background: var(--bg-main);
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 3rem;
    }

    .category-link {
        color: var(--text-muted);
        text-decoration: none;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: color 0.2s;
        border-bottom: 2px solid transparent;
    }

    .category-link:hover,
    .category-link.active {
        color: var(--text-main);
        border-bottom-color: var(--text-main);
    }

    .category-section {
        margin-bottom: 4rem;
        scroll-margin-top: 140px;
        /* Offset for sticky nav & filter */
    }

    .category-title {
        font-size: 2rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
    }

    .menu-item-card {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 2rem;
        margin-bottom: 2rem;
        transition: opacity 0.3s;
    }

    /* Last item in a row shouldn't have bottom margin in larger views, but grid handles it. Let's just border-bottom all and let the grid flow. */

    .menu-item-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background-color: var(--bg-alt);
    }

    .menu-item-title {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
        font-weight: 600;
        font-family: var(--font-heading);
    }

    .menu-item-desc {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .menu-item-price {
        font-family: var(--font-main);
        font-weight: 500;
        font-size: 1.1rem;
    }

    .dietary-icon {
        font-size: 0.75rem;
        margin-left: 0.5rem;
        color: var(--text-muted);
    }

    .stock-badge {
        font-size: 0.70rem;
        padding: 0.25em 0.6em;
        background: var(--bg-alt);
        color: var(--text-muted);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        /* Sharp pill */
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stock-badge.out {
        color: var(--danger-color);
        border-color: var(--danger-color);
        background: transparent;
    }

    /* Minimal Add To Cart Modal */
    .modal-content {
        border-radius: 0;
        border: 1px solid var(--border-color);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
    }

    .quantity-control {
        display: flex;
        align-items: center;
        border: 1px solid var(--border-color);
        border-radius: 0;
        overflow: hidden;
        width: fit-content;
    }

    .quantity-btn {
        background: transparent;
        border: none;
        color: var(--text-main);
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .quantity-btn:hover {
        background-color: var(--bg-alt);
    }

    .quantity-input {
        width: 50px;
        text-align: center;
        border: none;
        background: transparent;
        color: var(--text-main);
        font-weight: 500;
    }

    .quantity-input:focus {
        outline: none;
    }

    /* Cart Sidebar Minimalist */
    .cart-sidebar {
        position: sticky;
        top: 140px;
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .cart-header {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .cart-item {
        border-bottom: 1px dashed var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .cart-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .btn-remove {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 0.8rem;
        padding: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-decoration: underline;
    }

    .btn-remove:hover {
        color: var(--danger-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="menu-wrapper">
    <!-- Category Filter -->
    <div class="category-filter">
        <div class="container">
            <div class="d-flex overflow-auto pb-2 gap-2 custom-scrollbar">
                <a href="#all" class="category-link active">All Items</a>
                {% for category in categories %}
                <a href="#category-{{ category.id }}" class="category-link">{{ category.name }}</a>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="container fade-in">
        <div class="row g-5">
            <!-- Menu Items Column -->
            <div class="col-lg-8">
                {% for category in categories %}
                <div id="category-{{ category.id }}" class="category-section">
                    <h2 class="category-title font-heading">{{ category.name }}</h2>

                    <div class="row g-4">
                        {% for item in menu_items %}
                        {% if item.category == category %}
                        <div class="col-md-6">
                            <div class="menu-item-card h-100 d-flex flex-column">
                                {% if item.image %}
                                <img src="{{ item.image.url }}" class="menu-item-img mb-3" alt="{{ item.name }}">
                                {% endif %}
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h3 class="menu-item-title">{{ item.name }}</h3>
                                    <span class="menu-item-price">₹{{ item.price }}</span>
                                </div>
                                <p class="menu-item-desc flex-grow-1">{{ item.description }}</p>

                                <div class="d-flex justify-content-between align-items-center mt-auto pt-2">
                                    <div class="d-flex gap-2">
                                        {% if item.is_vegetarian %}
                                        <i class="fa-solid fa-leaf dietary-icon text-success" title="Vegetarian"></i>
                                        {% endif %}
                                        {% if item.is_vegan %}
                                        <i class="fa-solid fa-seedling dietary-icon text-success" title="Vegan"></i>
                                        {% endif %}
                                        {% if item.is_gluten_free %}
                                        <i class="fa-solid fa-wheat-awn-circle-exclamation dietary-icon text-warning"
                                            title="Gluten Free"></i>
                                        {% endif %}
                                    </div>

                                    {% if item.is_available %}
                                    <button class="btn btn-outline-primary btn-sm px-4 rounded-0"
                                        onclick="openOrderModal('{{ item.id }}', '{{ item.name }}', {{ item.price }})">
                                        Add
                                    </button>
                                    {% else %}
                                    <span class="stock-badge out">Sold Out</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <p class="text-muted text-center py-5">No menu categories available currently.</p>
                {% endfor %}
            </div>

            <!-- Cart Sidebar -->
            <div class="col-lg-4 d-none d-lg-block">
                <div class="cart-sidebar" id="cart">
                    <div class="cart-header d-flex justify-content-between align-items-center">
                        <h4 class="font-heading mb-0">Your Order</h4>
                        <span class="badge bg-primary rounded-0">{{ cart|length }} items</span>
                    </div>

                    {% if cart %}
                    <div class="cart-items-container mb-4" style="max-height: 400px; overflow-y: auto;">
                        {% for item in cart %}
                        <div class="cart-item">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="fw-bold mb-0">{{ item.name }} <span class="ms-1 text-muted fw-normal">x{{
                                        item.qty }}</span></h6>
                                <span class="fw-medium">₹{% widthratio item.price 1 item.qty %}</span>
                            </div>


                            {% if item.instructions %}
                            <div class="small text-muted fst-italic mb-2">"{{ item.instructions }}"</div>
                            {% endif %}

                            <div class="text-end">
                                <button type="button" class="btn-remove"
                                    onclick="removeFromCart('{{ item.cart_id }}')">Remove</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="cart-summary bg-alt p-3 mb-4 rounded-0">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted small text-uppercase">Subtotal</span>
                            <span class="fw-medium">₹{{ total|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small text-uppercase">Taxes</span>
                            <span class="fw-medium">Calculated at checkout</span>
                        </div>
                    </div>

                    <a href="{% url 'checkout' %}" class="btn btn-primary w-100 py-3 rounded-0 letter-spacing-1">
                        Go to Checkout <i class="fa-solid fa-arrow-right ms-2"></i>
                    </a>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fa-solid fa-bag-shopping fs-1 text-muted opacity-25 mb-3"></i>
                        <p class="text-muted mb-0">Your order is empty.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Cart Toggle Button -->
<a href="#cart"
    class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 p-0 d-flex d-lg-none align-items-center justify-content-center shadow-lg z-3"
    style="width: 60px; height: 60px;">
    <i class="fa-solid fa-bag-shopping fs-4"></i>
    {% if cart %}
    <span
        class="position-absolute top-0 start-100 translate-middle badge rounded-circle bg-danger border border-white p-2">
        {{ cart|length }}
    </span>
    {% endif %}
</a>

<!-- Add to Cart Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title font-heading fw-bold" id="modalItemName">Item Name</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'add_to_cart' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="item_id" id="modalItemId">
                <div class="modal-body p-4">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fs-5 fw-medium text-main" id="modalItemPrice">₹0.00</span>

                        <div class="quantity-control border">
                            <button type="button" class="quantity-btn" onclick="updateQty(-1)"><i
                                    class="fa-solid fa-minus fs-6"></i></button>
                            <input type="number" name="quantity" id="itemQuantity" class="quantity-input" value="1"
                                min="1" max="10" readonly>
                            <button type="button" class="quantity-btn" onclick="updateQty(1)"><i
                                    class="fa-solid fa-plus fs-6"></i></button>
                        </div>
                    </div>



                    <div>
                        <label class="form-label text-uppercase small text-muted">Special Instructions</label>
                        <textarea name="instructions" class="form-control border-1 rounded-0 shadow-none bg-transparent"
                            rows="2" placeholder="e.g. No onions, sauce on side"></textarea>
                    </div>
                </div>
                <!-- Need next param so 'add_to_cart' returns to menu.html -->
                <input type="hidden" name="next" value="{% url 'menu' %}">
                <div class="modal-footer border-top bg-light">
                    <button type="button" class="btn btn-outline-primary px-4 rounded-0"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4 rounded-0">Add to Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Quantity control handler
    function updateQty(change) {
        let input = document.getElementById('itemQuantity');
        let current = parseInt(input.value);
        if (current + change >= 1 && current + change <= 10) {
            input.value = current + change;
        }
    }

    // Modal data filler
    function openOrderModal(id, name, price) {
        document.getElementById('modalItemId').value = id;
        document.getElementById('modalItemName').textContent = name;
        document.getElementById('modalItemPrice').textContent = '₹' + price;
        document.getElementById('itemQuantity').value = 1; // Reset qty

        var myModal = new bootstrap.Modal(document.getElementById('orderModal'));
        myModal.show();
    }

    // Remove from cart API
    function removeFromCart(cartId) {
        fetch("{% url 'remove_from_cart' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ cart_id: cartId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error removing item: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Category smooth scroll and active state
    document.addEventListener("DOMContentLoaded", function () {
        const sections = document.querySelectorAll('.category-section');
        const navLinks = document.querySelectorAll('.category-link');

        // Setup observer for scrolling
        const observerOptions = {
            root: null,
            rootMargin: '-150px 0px -50% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === '#' + entry.target.id) {
                            link.classList.add('active');
                            // Ensure the link is visible in the scrollable nav
                            link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }
                    });
                }
            });
        }, observerOptions);

        sections.forEach(sec => observer.observe(sec));

        // Handle click scrolling
        navLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                // If the link is 'All Items', scroll to top of menu
                if (this.getAttribute('href') === '#all') {
                    e.preventDefault();
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                } else if (this.getAttribute('href').startsWith('#category-')) {
                    const targetId = this.getAttribute('href');
                    const targetEl = document.querySelector(targetId);
                    if (targetEl) {
                        e.preventDefault();
                        const offset = 140; // Account for sticky headers
                        const bodyRect = document.body.getBoundingClientRect().top;
                        const elementRect = targetEl.getBoundingClientRect().top;
                        const elementPosition = elementRect - bodyRect;
                        const offsetPosition = elementPosition - offset;

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });
                    }
                }
            });
        });
    });
</script>
{% endblock %}